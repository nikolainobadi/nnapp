//
//  OpenTests.swift
//  nnapp
//
//  Created by Nikolai Nobadi on 3/29/25.
//

import Testing
import CodeLaunchKit
import NnShellTesting
import SwiftPickerTesting
@testable import nnapp
@preconcurrency import Files

@MainActor
final class OpenTests: MainActorTempFolderDatasource {
    private let existingGroupName = "groupName"
    private let existingProjectName = "projectName"
    private let existingCategoryName = "categoryName"
    private let existingProjectShortcut = "projectShortcut"
    private let remote: SwiftDataProjectLink = .init(name: "GitHub", urlString: "github.git")
    
    init() throws {
        let testGroupFolder = TestFolder(name: existingGroupName, subFolders: [])
        let testCategoryFolder = TestFolder(name: existingCategoryName, subFolders: [testGroupFolder])
        
        try super.init(testFolder: .init(name: "openProjectCategoryList", subFolders: [testCategoryFolder]))
    }
}


// MARK: - Cannot Locate Tests
extension OpenTests {
    @Test("Throws error when can't find provided shortcut does not belong to existing Project or Group", arguments: [false, true])
    func throwsErrorWhenCannotFindProjectOrGroupWithShortcut(useGroupShortcut: Bool) {
        #expect(throws: (any Error).self) {
            try runCommand(shortcut: "missingShortcut", useGroupShortcut: useGroupShortcut)
        }
    }
}


// MARK: - IDE Tests
extension OpenTests {
    @Test("Throws error when selected Project folder doesn't exist and has no remote repo")
    func throwsErrorWhenSelectedProjectMissingAndNoRepo() throws {
        let factory = try makeFactory()
        let existingProjectShortcut = existingProjectShortcut
        
        #expect(throws: CodeLaunchError.noRemoteRepository) {
            try runCommand(factory, shortcut: existingProjectShortcut)
        }
    }
    
    // TODO: -
//    @Test("Throws error when selected Project folder doesn't exist and user does not want to clone")
//    func throwsErrorWhenSelectedProjectMissingUserRejectsCloning() throws {
//        let picker = MockPicker(shouldThrowError: true)
//        let factory = try makeFactory(remote: remote, picker: picker)
//        let existingProjectShortcut = existingProjectShortcut
//        
//        #expect(throws: (any Error).self) {
//            try runCommand(factory, shortcut: existingProjectShortcut)
//        }
//    }
    
    @Test("Clones missing project")
    func clonesMissingProject() throws {
        let shell = MockShell()
        let urlString = remote.urlString
        let factory = try makeFactory(remote: remote, shell: shell)
        
        try runCommand(factory, shortcut: existingProjectShortcut)
        
        #expect(shell.executedCommand(containing: "clone \(urlString)"))
    }
    
    @Test("Does not clone Project with remote repo when it exists locally")
    func doesNotCloneProjectThatExistsLocally() throws {
        let shell = MockShell()
        let urlString = remote.urlString
        let factory = try makeFactory(remote: remote, shell: shell)
        
        try makeProjectFolder()
        try runCommand(factory, shortcut: existingProjectShortcut)
        
        #expect(!shell.executedCommand(containing: "clone \(urlString)"))
    }
    
    @Test("Opens new terminal window when one is not already open at Project path")
    func opensNewTerminalWindowAtProjectPath() throws {
        let shell = MockShell()
        let factory = try makeFactory(shell: shell)
        
        try makeProjectFolder()
        try runCommand(factory, shortcut: existingProjectShortcut)
        
        #expect(shell.executedCommand(containing: "tell application"))
    }
    
    @Test("Does not open new terminal window when one is already open at Project path")
    func doesNotOpenTerminalWindowIfOneAlreadyIsOpen() throws {
        let projectFolder = try makeProjectFolder()
        let shell = MockShell(results: ["", projectFolder.path])
        let factory = try makeFactory(shell: shell)

        try runCommand(factory, shortcut: existingProjectShortcut)

        #expect(!shell.executedCommand(containing: "cd \(projectFolder.path)"))
    }
    
    @Test("Opens Project file in Xcode")
    func opensProjectInXcode() throws {
        let shell = MockShell()
        let factory = try makeFactory(shell: shell)
        
        try makeProjectFolder()
        try runCommand(factory, shortcut: existingProjectShortcut)
        
        let context = try factory.makeContext()
        let project = try #require(try context.loadProjects().first)
        let filePath = try #require(project.filePath)
        
        #expect(shell.executedCommand(containing: "open \(filePath)"))
    }
    
    @Test("Opens project folder in VSCode")
    func opensProjectInVSCode() throws {
        let shell = MockShell()
        let factory = try makeFactory(shell: shell)
        
        try makeProjectFolder()
        try runCommand(factory, shortcut: existingProjectShortcut, launchType: .vscode)
        
        let context = try factory.makeContext()
        let project = try #require(try context.loadProjects().first)
        let folderPath = try #require(project.folderPath)
        
        #expect(shell.executedCommand(containing: "code \(folderPath)"))
    }
}


// MARK: - Remote Tests
extension OpenTests {
    @Test("Throws error when trying to open remote repo if Project doesn't have one")
    func throwsErrorWhenOpeningRepoForProjectWithoutOne() throws {
        let factory = try makeFactory()
        let existingProjectShortcut = existingProjectShortcut
        
        #expect(throws: CodeLaunchError.missingGitRepository) {
            try runCommand(factory, shortcut: existingProjectShortcut, launchType: .remote)
        }
    }

    @Test("Open remote repo website for Project")
    func opensRemoteRepo() throws {
        let shell = MockShell()
        let urlString = remote.urlString
        let factory = try makeFactory(remote: remote, shell: shell)
        
        try makeProjectFolder()
        try runCommand(factory, shortcut: existingProjectShortcut, launchType: .remote)

        #expect(shell.executedCommand(containing: "open \(urlString)"))
    }
}


// MARK: - OtherLink Tests
extension OpenTests {
    @Test("Throws error when trying to open ProjectLink for Project without any links")
    func throwsErrorWhenOpeningLinkForProjectWithoutLinks() throws {
        let factory = try makeFactory()
        let existingProjectShortcut = existingProjectShortcut

        #expect(throws: CodeLaunchError.missingProjectLink) {
            try runCommand(factory, shortcut: existingProjectShortcut, launchType: .link)
        }
    }

    @Test("Opens ProjectLink for Project")
    func opensProjectLink() throws {
        let shell = MockShell()
        let link = SwiftDataProjectLink(name: "Docs", urlString: "https://docs.example.com")
        let factory = try makeFactory(projectLinks: [link], shell: shell)
        
        try runCommand(factory, shortcut: existingProjectShortcut, launchType: .link)

        #expect(shell.executedCommand(containing: "open \(link.urlString)"))
    }
}


// MARK: - Factory
private extension OpenTests {
    @discardableResult
    func makeProjectFolder() throws -> Folder {
        let categoryFolder = try tempFolder.subfolder(named: existingCategoryName)
        let groupFolder = try categoryFolder.subfolder(named: existingGroupName)
        
        return try groupFolder.createSubfolder(named: existingProjectName)
    }
    
    func makeFactory(remote: SwiftDataProjectLink? = nil, projectLinks: [SwiftDataProjectLink] = [], shell: MockShell = .init()) throws -> MockContextFactory {
        let picker = MockSwiftPicker(
            permissionResult: .init(defaultValue: true),
            selectionResult: .init(defaultSingle: .index(0))
        )
        let factory = MockContextFactory(shell: shell, picker: picker)
        let context = try factory.makeContext()
        let existingCategoryFolder = try tempFolder.subfolder(named: existingCategoryName)
        let category = makeSwiftDataCategory(name: existingCategoryName, path: existingCategoryFolder.path)
        let group = makeSwiftDataGroup(name: existingGroupName)
        let project = makeSwiftDataProject(name: existingProjectName, shortcut: existingProjectShortcut, remote: remote, links: projectLinks)

        try context.saveCategory(category)
        try context.saveGroup(group, in: category)
        try context.saveProject(project, in: group)

        return factory
    }
}


// MARK: - RunCommand
private func runCommand(_ factory: MockContextFactory? = nil, shortcut: String? = nil, launchType: LaunchType = .xcode, useGroupShortcut: Bool = false) throws {
    var args = ["open", "-\(launchType.argChar)"]
    
    if useGroupShortcut {
        args.append("-g")
    }
    
    if let shortcut {
        args.append(shortcut)
    }
    
    try Nnapp.testRun(contextFactory: factory, args: args)
}
